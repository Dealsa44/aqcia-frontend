<div class="catalog-page">
  <div class="page-container">
    <div class="catalog-card">
      <h1>{{ getCurrentText(catalogMocks.title) }}</h1>

      <div class="filters">
        <div class="category-filter-actions">
          <button
            class="select-categories-button main-category-button"
            (click)="openCategoryModal()"
          >
            {{ getCurrentText(catalogMocks.selectCategoriesButton) }}
            <span *ngIf="selectedCategories.length > 0" class="category-count-badge">{{ selectedCategories.length }}</span>
          </button>
          <button class="clear" (click)="clearFilters()">
            {{ getCurrentText(catalogMocks.clearFiltersButton) }}
          </button>
        </div>
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="searchProducts()"
          [placeholder]="getCurrentText(catalogMocks.searchPlaceholder)"
        />
      </div>

      <div class="results">
        <!-- Loading state -->
        <div *ngIf="isLoadingProducts || isInitialLoad" class="loading">
          <p>Loading products from Agrohub...</p>
          <div class="loading-spinner"></div>
        </div>
        
        <!-- Error state -->
        <div *ngIf="errorMessage" class="error">
          <p>{{ errorMessage }}</p>
        </div>
        
        <!-- Products grid -->
        <div *ngIf="!isLoadingProducts && filteredProducts.length > 0" class="product-grid">
          <div *ngFor="let product of filteredProducts; trackBy: trackByProductId" class="product-card">
            <img
              [src]="product.image.startsWith('http') ? product.image : 'assets/imgs/products/' + product.image"
              [alt]="getCurrentText(product.name)"
              [routerLink]="[
                '/',
                languageService.getCurrentLanguageCode(),
                'product',
                product.id
              ]"
            />
            <div class="product-info">
              <h3
                [routerLink]="[
                  '/',
                  languageService.getCurrentLanguageCode(),
                  'product',
                  product.id
                ]"
              >
                {{ getCurrentText(product.name) }}
              </h3>
              <div class="price-info">
                <span class="best-price">
                  {{ getCurrentText(catalogMocks.bestPriceLabel) }}
                  <strong>{{ getLowestPrice(product).price.toFixed(2) }} ₾</strong>
                  ({{ getLowestPrice(product).market }})
                </span>
              </div>
              <button class="add-to-cart" (click)="addToCart(product, $event)">
                {{ getCurrentText(catalogMocks.addToCartButton) }}
              </button>
            </div>
          </div>
        </div>
        <div *ngIf="!isLoadingProducts && filteredProducts.length === 0" class="no-results">
          {{ getCurrentText(catalogMocks.noResultsMessage) }}
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="showCategoryModal" class="modal-overlay" (click)="closeCategoryModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>{{ getCurrentText(catalogMocks.selectCategoriesButton) }}</h2>

      <div class="modal-search-container">
        <input
          type="text"
          [(ngModel)]="modalSearchTerm"
          (input)="filterModalCategories()"
          [placeholder]="getCurrentText(catalogMocks.modalSearchPlaceholder)"
          class="modal-search-input"
        />
      </div>
      
      <div class="category-checkboxes">
        <div *ngIf="filteredModalCategories.length > 0">
          <label *ngFor="let category of filteredModalCategories; trackBy: trackByCategoryId" class="category-item">
            <input
              type="checkbox"
              [value]="category.id"
              (change)="onCategoryCheckboxChange($event)"
              [checked]="selectedCategories.includes(category.id)"
            />
            {{ getCurrentText(category.name) }}
            <span class="product-count">
              ({{ getProductsInCategoryCount(category.id) }})
            </span>
          </label>
        </div>
        <div *ngIf="filteredModalCategories.length === 0" class="no-results">
          {{ getCurrentText(catalogMocks.noResultsMessage) }}
        </div>
      </div>
      
      <button class="apply-filters-button" (click)="applyCategoryFilters()">
        {{ getCurrentText(catalogMocks.applyFiltersButton) }}
      </button>
      <button class="close-modal-button" (click)="closeCategoryModal()">
        ✖
      </button>
    </div>
  </div>
</div>
